---
- hosts: all

  tasks:

    - name: Create VM from template
      community.general.proxmox_kvm:
        node: "{{ node }}"
        api_host: "{{ proxmox_host }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        api_user: "{{ api_user }}"
        vmid: "{{ vm_id }}"
        name: "{{ vm_name }}"
        clone: "{{ template_id }}"
        full: yes
        memory: "{{ memory }}"
        cores: "{{ cores }}"
        cpu: "{{ cpus }}"
        boot: c
        bootdisk: scsi0
        agent: 1
        onboot: true
        storage: local-lvm

    - name: Configure Cloud-Init for the VM
      community.general.proxmox_kvm:
        node: "{{ node }}"
        api_host: "{{ proxmox_host }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        api_user: "{{ api_user }}"
        vmid: "{{ template_id }}"
        ciuser: "ubuntu"                   # Default Ubuntu Cloud-Init user
        cipassword: "ubuntu_password"      # Password for the Cloud-Init user
        ipconfig: "{{ ipconfig }}"
        nameservers: "{{ nameserver }}"

    - name: Start the VM
      community.general.proxmox_kvm:
        node: "{{ node }}"
        api_host: "{{ proxmox_host }}"
        api_token_id: "{{ proxmox_token_id }}"
        api_token_secret: "{{ proxmox_token_secret }}"
        api_user: "{{ api_user }}"
        vmid: "{{ template_id }}"
        state: started